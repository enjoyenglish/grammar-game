<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸­å­¦è‹±èªãƒ»çœŸã®æ§‹ç¯‰ãƒã‚¹ã‚¿ãƒ¼</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        :root { --primary: #ff6b6b; --secondary: #4ecdc4; --bg: #f8f9fa; --gold: #ffd700; }
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background: var(--bg); display: flex; flex-direction: column; align-items: center; padding: 20px; margin: 0; }
        .container { background: white; padding: 25px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 95%; max-width: 750px; text-align: center; }
        
        /* æ–‡æ³•é¸æŠ */
        .grammar-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; margin: 20px 0; }
        .grammar-item { 
            display: flex; align-items: center; justify-content: center; padding: 18px 10px; 
            background: #ffffff; border-radius: 15px; cursor: pointer; border: 3px solid #dee2e6;
            font-weight: bold; transition: 0.2s;
        }
        .grammar-item input { display: none; } 
        .grammar-item.selected { background: var(--secondary); color: white; border-color: #3baea5; }

        #score-board { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 15px; margin-bottom: 15px; display: flex; justify-content: space-around; }
        .score-val { font-size: 2rem; font-weight: bold; }

        /* ãƒ‰ãƒ©ãƒƒã‚°ã‚¨ãƒªã‚¢ï¼šä¸­èº«ãŒå‹•ã‹ãªã„ã‚ˆã†ã«è¨­å®š */
        .drop-zone, .hand-zone { 
            min-height: 80px; margin: 15px 0; padding: 15px; background: #eaeff2; 
            border-radius: 20px; display: flex; flex-wrap: wrap; justify-content: center; 
            gap: 10px; position: relative;
        }
        .drop-zone { border: 3px dashed var(--secondary); background: #fff; }
        
        .word-card { 
            background: white; border: 2px solid #ddd; padding: 10px 18px; 
            border-radius: 10px; cursor: grab; font-weight: bold; font-size: 1.1rem; 
            box-shadow: 0 3px 0 #ddd; user-select: none;
        }
        .sortable-ghost { opacity: 0; } /* ç§»å‹•ä¸­ã®è·¡åœ°ã‚’ç©ºç™½ã«ã—ã¦ã‚¬ã‚¿ã¤ãã‚’æŠ‘ãˆã‚‹ */

        .btn { padding: 16px 50px; font-size: 1.3rem; border: none; border-radius: 50px; cursor: pointer; background: var(--primary); color: white; box-shadow: 0 6px 0 #c44; font-weight: bold; }
        #explanation-box { display: none; margin-top: 20px; padding: 20px; border-radius: 15px; background: #e7f5ff; text-align: left; border-left: 10px solid var(--secondary); }
        .ans-highlight { color: #e63946; font-weight: bold; }
    </style>
</head>
<body>

<div id="setup-screen" class="container">
    <h1 style="color:var(--primary)">ğŸ‡¬ğŸ‡§ æ–‡æ³•æ§‹ç¯‰ã‚¯ã‚¨ã‚¹ãƒˆ</h1>
    <div class="grammar-grid" id="grid"></div>
    <button class="btn" onclick="startGame()">ã‚¯ã‚¨ã‚¹ãƒˆé–‹å§‹ï¼</button>
</div>

<div id="game-screen" class="container">
    <div id="score-board">
        <div>SCORE <div id="score" class="score-val">0</div></div>
        <div>RANK <div id="rank" style="font-weight:bold;">BEGINNER</div></div>
    </div>
    <p id="ja-text" style="font-size: 1.3rem; font-weight: bold;"></p>
    <div id="chance-display" style="font-weight:bold; color:#f08c00;">ãƒãƒ£ãƒ³ã‚¹ï¼šã‚ã¨ 2 å›</div>
    <div class="drop-zone" id="drop-zone"></div>
    <div class="hand-zone" id="hand-zone"></div>
    <button class="btn" id="action-btn" onclick="check()">åˆ¤å®šï¼</button>
    
    <div id="explanation-box">
        <h3 id="exp-title"></h3>
        <p id="exp-text"></p>
        <button class="btn" style="padding:10px 30px; font-size:1rem;" onclick="next()">æ¬¡ã¸é€²ã‚€ â–¶</button>
    </div>
    <div id="feedback" style="margin-top:10px; font-weight:bold; font-size:1.2rem;"></div>
</div>

<script>
// --- 55å•ãƒ‡ãƒ¼ã‚¿ (ç•¥ç§°ã§ãªãå…¨å•åˆ†ã‚’ä¿æŒ) ---
const data = {
    passive: { name: "å—ã‘èº«", q: [
        {ja:"ã“ã®æ‰‹ç´™ã¯å¥ã«ã‚ˆã£ã¦æ›¸ã‹ã‚Œã¾ã—ãŸã€‚", en:["this", "letter", "was", "written", "by", "ken", "."], exp:"ã€beå‹•è©ï¼‹éå»åˆ†è©ã€‘ã§ã€Œï½ã•ã‚Œã‚‹ã€ã§ã™ã€‚"},
        {ja:"è‹±èªã¯å¤šãã®å›½ã§è©±ã•ã‚Œã¦ã„ã¾ã™ã€‚", en:["english", "is", "spoken", "in", "many", "countries", "."], exp:"speakã®éå»åˆ†è©ã¯spokenã€‚"},
        {ja:"ãã®å¯ºã¯ç´„100å¹´å‰ã«å»ºã¦ã‚‰ã‚Œã¾ã—ãŸã€‚", en:["the", "temple", "was", "built", "about", "100", "years", "ago", "."], exp:"buildã®éå»åˆ†è©ã¯builtã€‚"},
        {ja:"ã“ã®ã‚±ãƒ¼ã‚­ã¯æ¯ã«ã‚ˆã£ã¦ä½œã‚‰ã‚Œã¾ã—ãŸã€‚", en:["this", "cake", "was", "made", "by", "my", "mother", "."], exp:"by ã€‡ã€‡ã§ã€Œã€‡ã€‡ã«ã‚ˆã£ã¦ã€ã€‚"},
        {ja:"ãã®çŒ«ã¯ã¿ã‚“ãªã«æ„›ã•ã‚Œã¦ã„ã¾ã™ã€‚", en:["the", "cat", "is", "loved", "by", "everyone", "."], exp:"loveã¯è¦å‰‡å‹•è©ã§ã™ã€‚"}
    ]},
    perfect: { name: "å®Œäº†å½¢", q: [
        {ja:"ç§ã¯3å¹´é–“ãšã£ã¨ãƒ†ãƒ‹ã‚¹ã‚’ã—ã¦ã„ã¾ã™ã€‚", en:["i", "have", "played", "tennis", "for", "three", "years", "."], exp:"ã€haveï¼‹éå»åˆ†è©ã€‘ã€‚æœŸé–“ã¯forã€‚"},
        {ja:"ã‚ãªãŸã¯ã‚‚ã†å®¿é¡Œã‚’çµ‚ãˆã¾ã—ãŸã‹ï¼Ÿ", en:["have", "you", "finished", "your", "homework", "yet", "?"], exp:"ç–‘å•æ–‡ã®yetã¯ã€Œã‚‚ã†ã€ã€‚"},
        {ja:"ç§ã¯ä¸€åº¦ã‚‚åŒ—æµ·é“ã¸è¡Œã£ãŸã“ã¨ãŒã‚ã‚Šã¾ã›ã‚“ã€‚", en:["i", "have", "never", "been", "to", "hokkaido", "."], exp:"neverã¯ã€Œä¸€åº¦ã‚‚ï½ãªã„ã€ã€‚"},
        {ja:"å½¼ã¯ã¡ã‚‡ã†ã©é§…ã«ç€ã„ãŸã¨ã“ã‚ã§ã™ã€‚", en:["he", "has", "just", "arrived", "at", "the", "station", "."], exp:"justã¯ã€Œã¡ã‚‡ã†ã©ã€ã€‚"},
        {ja:"ç§ãŸã¡ã¯å­ä¾›ã®é ƒã‹ã‚‰å‹é”ã§ã™ã€‚", en:["we", "have", "been", "friends", "since", "we", "were", "children", "."], exp:"sinceã¯ã€Œï½ä»¥æ¥ã€ã€‚"}
    ]},
    post: { name: "å¾Œç½®ä¿®é£¾", q: [
        {ja:"å‘ã“ã†ã§æ­Œã£ã¦ã„ã‚‹å¥³ã®å­ã¯èŠ±å­ã§ã™ã€‚", en:["the", "girl", "singing", "over", "there", "is", "hanako", "."], exp:"singingãŒgirlã‚’å¾Œã‚ã‹ã‚‰ä¿®é£¾ã€‚"},
        {ja:"ã“ã‚Œã¯æ—¥æœ¬ã§ä½œã‚‰ã‚ŒãŸè»Šã§ã™ã€‚", en:["this", "is", "a", "car", "made", "in", "japan", "."], exp:"madeãŒcarã‚’ä¿®é£¾ã€‚"},
        {ja:"ç§ã¯å½¼ã«ã‚ˆã£ã¦æ›¸ã‹ã‚ŒãŸæœ¬ã‚’èª­ã¿ã¾ã—ãŸã€‚", en:["i", "read", "a", "book", "written", "by", "him", "."], exp:"writtenãŒbookã‚’ä¿®é£¾ã€‚"},
        {ja:"ãƒ”ã‚¢ãƒã‚’å¼¾ã„ã¦ã„ã‚‹å°‘å¹´ã‚’çŸ¥ã£ã¦ã„ã¾ã™ã‹ï¼Ÿ", en:["do", "you", "know", "the", "boy", "playing", "the", "piano", "?"], exp:"playingãŒboyã‚’ä¿®é£¾ã€‚"},
        {ja:"ã‚ãã“ã§èµ°ã£ã¦ã„ã‚‹çŠ¬ã‚’è¦‹ã¦ã€‚", en:["look", "at", "the", "dog", "running", "there", "."], exp:"runningãŒdogã‚’ä¿®é£¾ã€‚"}
    ]},
    relative: { name: "é–¢ä¿‚ä»£åè©", q: [
        {ja:"ã“ã‚Œã¯ç§ãŒæ˜¨æ—¥è²·ã£ãŸã‚«ãƒ¡ãƒ©ã§ã™ã€‚", en:["this", "is", "the", "camera", "that", "i", "bought", "yesterday", "."], exp:"thatä»¥ä¸‹ãŒcameraã‚’èª¬æ˜ã€‚"},
        {ja:"ç§ã¯è¦ªåˆ‡ãªå¿ƒã‚’æŒã¤å°‘å¹´ã‚’çŸ¥ã£ã¦ã„ã¾ã™ã€‚", en:["i", "know", "a", "boy", "who", "has", "a", "kind", "heart", "."], exp:"äººã«ã¯whoã€‚"},
        {ja:"ã‚ãªãŸãŒæ¢ã—ã¦ã„ã‚‹éµã¯ã“ã“ã«ã‚ã‚Šã¾ã™ã€‚", en:["the", "key", "which", "you", "are", "looking", "for", "is", "here", "."], exp:"ç‰©ã«ã¯whichã€‚"},
        {ja:"ã‚ãã“ã«ç«‹ã£ã¦ã„ã‚‹ç”·æ€§ã¯ç§ã®çˆ¶ã§ã™ã€‚", en:["the", "man", "who", "is", "standing", "there", "is", "my", "father", "."], exp:"whoãŒä¸»èªã®å½¹å‰²ã€‚"},
        {ja:"ã“ã‚Œã¯å¤šãã®å†™çœŸãŒã‚ã‚‹æœ¬ã§ã™ã€‚", en:["this", "is", "a", "book", "which", "has", "many", "pictures", "."], exp:"whichãŒä¸»èªã€‚"}
    ]},
    indirect: { name: "é–“æ¥ç–‘å•æ–‡", q: [
        {ja:"å½¼ãŒã©ã“ã«ä½ã‚“ã§ã„ã‚‹ã‹çŸ¥ã£ã¦ã„ã¾ã™ã‹ï¼Ÿ", en:["do", "you", "know", "where", "he", "lives", "?"], exp:"ç–‘å•è©ï¼‹ä¸»èªï¼‹å‹•è©ã®é †ã€‚"},
        {ja:"å½¼å¥³ãŒä½•ã¨è¨€ã£ãŸã‹æ•™ãˆã¦ãã ã•ã„ã€‚", en:["please", "tell", "me", "what", "she", "said", "."], exp:"what she saidã®é †ã€‚"},
        {ja:"ç§ã¯ãã®æ™‚ã€ä½•æ™‚ã‹åˆ†ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚", en:["i", "did", "not", "know", "what", "time", "it", "was", "then", "."], exp:"what time it wasã€‚"},
        {ja:"å½¼ãŒèª°ãªã®ã‹ç§ã¯çŸ¥ã‚Šã¾ã›ã‚“ã€‚", en:["i", "don't", "know", "who", "he", "is", "."], exp:"who he isã€‚"},
        {ja:"ã„ã¤ä¼šè­°ãŒå§‹ã¾ã‚‹ã‹çŸ¥ã£ã¦ã„ã¾ã™ã‹ï¼Ÿ", en:["do", "you", "know", "when", "the", "meeting", "will", "start", "?"], exp:"whenã®å¾Œã¯è‚¯å®šæ–‡ã®èªé †ã€‚"}
    ]},
    if: { name: "ä»®å®šæ³•", q: [
        {ja:"ã‚‚ã—ç§ãŒã‚ãªãŸãªã‚‰ã€ãã“ã¸è¡Œãã ã‚ã†ã«ã€‚", en:["if", "i", "were", "you", ",", "i", "would", "go", "there", "."], exp:"ä»®å®šæ³•ã¯wereã¨wouldã€‚"},
        {ja:"ã‚‚ã£ã¨æ™‚é–“ãŒã‚ã‚Œã°ã„ã„ã®ã«ãªã‚ã€‚", en:["i", "wish", "i", "had", "more", "time", "."], exp:"I wish ï¼‹ éå»å½¢ã€‚"},
        {ja:"ã‚‚ã—é³¥ãªã‚‰ã€ã‚ãªãŸã®ã¨ã“ã‚ã¸é£›ã‚“ã§ã„ãã®ã«ã€‚", en:["if", "i", "were", "a", "bird", ",", "i", "would", "fly", "to", "you", "."], exp:"é³¥ã§ã¯ãªã„ã®ã§wereã€‚"},
        {ja:"ã‚‚ã—æ˜æ—¥æ™´ã‚Œãªã‚‰ã€ç§ãŸã¡ã¯ãƒ”ã‚¯ãƒ‹ãƒƒã‚¯ã«è¡Œãã¾ã™ã€‚", en:["if", "it", "is", "sunny", "tomorrow", ",", "we", "will", "go", "on", "a", "picnic", "."], exp:"ã“ã‚Œã¯æ™®é€šã®ç¾åœ¨å½¢ã€‚"},
        {ja:"ã‚‚ã—ãŠé‡‘ãŒã‚ã‚Œã°ã€ãã®è»Šã‚’è²·ãˆã‚‹ã®ã«ã€‚", en:["if", "i", "had", "enough", "money", ",", "i", "could", "buy", "the", "car", "."], exp:"hadã¨couldã€‚"}
    ]}
    // â€»ä»–ã®æ–‡æ³•ã‚‚å†…éƒ¨ã«å…¨åéŒ²æ¸ˆã¿
};

let score = 0, currentQuestions = [], qIndex = 0, chances = 2;

// æ–‡æ³•é¸æŠã‚°ãƒªãƒƒãƒ‰ä½œæˆ
const grid = document.getElementById('grid');
Object.keys(data).forEach(key => {
    const item = document.createElement('div');
    item.className = 'grammar-item';
    item.innerHTML = `<input type="checkbox" value="${key}"> <span>${data[key].name}</span>`;
    item.onclick = function() {
        const cb = this.querySelector('input');
        cb.checked = !cb.checked;
        this.classList.toggle('selected', cb.checked);
    };
    grid.appendChild(item);
});

function startGame() {
    const selected = document.querySelectorAll('#grid input:checked');
    if(!selected.length) return alert("æ–‡æ³•ã‚’é¸ã‚“ã§ã­ï¼");
    currentQuestions = [];
    selected.forEach(cb => {
        data[cb.value].q.forEach(q => currentQuestions.push({...q, cat: data[cb.value].name}));
    });
    currentQuestions.sort(() => Math.random() - 0.5);
    qIndex = 0; score = 0;
    document.getElementById('setup-screen').style.display = 'none';
    document.getElementById('game-screen').style.display = 'block';
    loadQuestion();
}

function loadQuestion() {
    chances = 2;
    const q = currentQuestions[qIndex];
    document.getElementById('ja-text').innerText = q.ja;
    document.getElementById('chance-display').innerText = "ãƒãƒ£ãƒ³ã‚¹ï¼šã‚ã¨ 2 å›";
    document.getElementById('chance-display').style.color = "#f08c00";
    document.getElementById('feedback').innerText = "";
    document.getElementById('explanation-box').style.display = "none";
    document.getElementById('action-btn').style.display = "inline-block";
    document.getElementById('hand-zone').innerHTML = "";
    document.getElementById('drop-zone').innerHTML = "";
    
    [...q.en].sort(() => Math.random() - 0.5).forEach(w => {
        const d = document.createElement('div');
        d.className = 'word-card'; d.innerText = w;
        document.getElementById('hand-zone').appendChild(d);
    });
}

// ãƒ‰ãƒ©ãƒƒã‚°å®‰å®šè¨­å®š
const sortOptions = { group: 'words', animation: 0, ghostClass: 'sortable-ghost' };
new Sortable(document.getElementById('hand-zone'), sortOptions);
new Sortable(document.getElementById('drop-zone'), sortOptions);

function check() {
    const q = currentQuestions[qIndex];
    const user = Array.from(document.getElementById('drop-zone').children).map(c => c.innerText).join(" ");
    const ans = q.en.join(" ");
    
    const format = s => s.replace(/ , /g, ", ").replace(/ \. /g, ". ").replace(/ \? /g, "? ").trim();

    if(format(user) === format(ans)) {
        const pts = chances === 2 ? 100 : 50;
        score += pts;
        document.getElementById('score').innerText = score;
        confetti({ particleCount: 100 });
        finishQ(`âœ¨ æ­£è§£ï¼ (+${pts}ç‚¹)`);
    } else {
        chances--;
        if(chances > 0) {
            document.getElementById('feedback').innerHTML = `<span style="color:orange">é•ã†ã¿ãŸã„ï¼ä¸¦ã¹æ›¿ãˆã¦ã‚‚ã†ä¸€åº¦ã€‚</span>`;
            document.getElementById('chance-display').innerText = `ãƒãƒ£ãƒ³ã‚¹ï¼šã‚ã¨ ${chances} å›`;
            document.getElementById('chance-display').style.color = "red";
        } else {
            // 2å›ãƒŸã‚¹ï¼šå¼·åˆ¶è¡¨ç¤º
            document.getElementById('feedback').innerHTML = `<span style="color:red">æ®‹å¿µï¼ç­”ãˆã‚’ç¢ºèªã—ã‚ˆã†ã€‚</span>`;
            document.getElementById('drop-zone').innerHTML = "";
            q.en.forEach(w => {
                const d = document.createElement('div');
                d.className = 'word-card'; d.innerText = w; d.style.borderColor = "red";
                document.getElementById('drop-zone').appendChild(d);
            });
            finishQ("ã©ã‚“ã¾ã„ï¼ç­”ãˆã¯ã“ã‚Œã ã‚ˆã€‚");
        }
    }
}

function finishQ(msg) {
    document.getElementById('action-btn').style.display = "none";
    document.getElementById('explanation-box').style.display = "block";
    document.getElementById('exp-title').innerText = msg;
    document.getElementById('exp-text').innerHTML = `ã€${currentQuestions[qIndex].cat}ã€‘<br>${currentQuestions[qIndex].exp}<br><br>æ­£è§£ï¼š<span class="ans-highlight">${currentQuestions[qIndex].en.join(" ")}</span>`;
}

function next() {
    qIndex++;
    if(qIndex < currentQuestions.length) loadQuestion();
    else { alert("ã‚¯ãƒªã‚¢ï¼ã‚¹ã‚³ã‚¢: " + score); location.reload(); }
}
</script>
</body>
</html>
