<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸­å­¦è‹±èªãƒ»çœŸã®æ§‹ç¯‰ãƒã‚¹ã‚¿ãƒ¼</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        :root { --primary: #ff6b6b; --secondary: #4ecdc4; --bg: #f8f9fa; --accent: #ffe66d; --gold: #ffd700; }
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background: var(--bg); display: flex; flex-direction: column; align-items: center; padding: 20px; margin: 0; }
        .container { background: white; padding: 25px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 95%; max-width: 750px; text-align: center; }
        
        /* è±ªè¯ã‚¹ã‚³ã‚¢è¡¨ç¤º */
        #score-board { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 15px; margin-bottom: 15px; display: flex; justify-content: space-around; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .score-val { font-size: 2rem; font-weight: bold; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .rank-badge { background: var(--gold); color: #333; padding: 5px 15px; border-radius: 50px; font-weight: bold; font-size: 0.9rem; border: 2px solid white; }

        .drop-zone { min-height: 110px; margin: 15px 0; padding: 15px; background: #fff; border: 3px dashed var(--secondary); border-radius: 20px; display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; position: relative; transition: 0.3s; }
        .drop-zone:empty::before { content: "ã“ã“ã«ãƒ”ãƒªã‚ªãƒ‰ã‚‚å«ã‚ã¦ä¸¦ã¹ã¦ã­"; color: #bbb; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .hand-zone { min-height: 110px; margin: 10px 0; padding: 15px; background: #eaeff2; border-radius: 20px; display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; }
        
        .word-card { background: white; border: 2px solid #ddd; padding: 12px 20px; border-radius: 12px; cursor: grab; font-weight: bold; font-size: 1.2rem; box-shadow: 0 4px 0 #ddd; transition: 0.2s; }
        .word-card:active { transform: translateY(2px); box-shadow: none; }
        .word-card.period { background: #eee; color: var(--primary); }

        .btn { padding: 16px 50px; font-size: 1.3rem; border: none; border-radius: 50px; cursor: pointer; background: var(--primary); color: white; box-shadow: 0 6px 0 #c44; font-weight: bold; transition: 0.2s; }
        .btn:hover { transform: scale(1.05); }
        .btn:active { transform: translateY(3px); box-shadow: 0 3px 0 #c44; }

        /* è§£èª¬ã‚¨ãƒªã‚¢ */
        #explanation-box { display: none; margin-top: 20px; padding: 20px; border-radius: 15px; background: #e7f5ff; border-left: 10px solid var(--secondary); text-align: left; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .notice { font-size: 0.85rem; color: #e63946; font-weight: bold; margin-bottom: 10px; }
        .grammar-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin: 20px 0; }
        .grammar-grid label { padding: 12px; background: #f1f3f5; border-radius: 12px; cursor: pointer; transition: 0.2s; border: 2px solid transparent; font-weight: bold; }
        .grammar-grid input:checked + span { color: white; }
        .grammar-grid label:has(input:checked) { background: var(--secondary); border-color: #3baea5; color: white; }
        #game-screen { display: none; }
    </style>
</head>
<body>

<div id="setup-screen" class="container">
    <h1 style="color:var(--primary)">ğŸ‡¬ğŸ‡§ æ–‡æ³•æ§‹ç¯‰ã‚¯ã‚¨ã‚¹ãƒˆ</h1>
    <p>å¼·åŒ–ã—ãŸã„æ–‡æ³•ã‚’ã‚»ãƒ¬ã‚¯ãƒˆã—ã‚ˆã†ï¼</p>
    <div class="grammar-grid" id="grid"></div>
    <button class="btn" onclick="startGame()">ã‚¯ã‚¨ã‚¹ãƒˆé–‹å§‹ï¼</button>
</div>

<div id="game-screen" class="container">
    <div id="score-board">
        <div>SCORE <div id="score" class="score-val">0</div></div>
        <div>RANK <div id="rank" class="rank-badge">BEGINNER</div></div>
    </div>
    <div class="notice">âš ï¸ æ–‡é ­ã‚‚å°æ–‡å­—ã§ã™ã€‚ãƒ”ãƒªã‚ªãƒ‰ã€Œ . ã€ã‚‚æœ€å¾Œã«ä¸¦ã¹ã¦ã­ï¼</div>
    <p id="q-count" style="color:#888; margin:0;"></p>
    <p id="ja-text" style="font-size: 1.4rem; font-weight: bold; margin: 15px 0; color: #2d3436;"></p>
    
    <div class="drop-zone" id="drop-zone"></div>
    <div class="hand-zone" id="hand-zone"></div>
    
    <button class="btn" id="action-btn" onclick="check()">åˆ¤å®šï¼</button>
    
    <div id="explanation-box">
        <h3 style="margin-top:0; color:#0b7285;">ğŸ’¡ è§£èª¬ã‚³ãƒ¼ãƒŠãƒ¼</h3>
        <p id="exp-grammar" style="font-weight:bold; margin-bottom:5px;"></p>
        <p id="exp-text" style="line-height:1.5;"></p>
        <button class="btn" style="padding:10px 30px; font-size:1rem;" onclick="next()">æ¬¡ã¸é€²ã‚€ â–¶</button>
    </div>
    <div id="feedback" style="margin-top:15px; font-size:1.5rem;"></div>
</div>

<script>
const data = {
    passive: { name: "å—ã‘èº«", q: [
        {ja:"ã“ã®æ‰‹ç´™ã¯å¥ã«ã‚ˆã£ã¦æ›¸ã‹ã‚Œã¾ã—ãŸã€‚", en:["this", "letter", "was", "written", "by", "ken", "."], exp:"ã€beå‹•è©ï¼‹éå»åˆ†è©ã€‘ã§ã€Œï½ã•ã‚Œã‚‹ã€ã¨ã„ã†æ„å‘³ã€‚by ã€‡ã€‡ã§ã€Œã€‡ã€‡ã«ã‚ˆã£ã¦ã€ã‚’è¡¨ã—ã¾ã™ã€‚"},
        {ja:"è‹±èªã¯å¤šãã®å›½ã§è©±ã•ã‚Œã¦ã„ã¾ã™ã€‚", en:["english", "is", "spoken", "in", "many", "countries", "."], exp:"speakã®éå»åˆ†è©ã¯spokenã§ã™ã€‚ä¸è¦å‰‡å¤‰åŒ–ã«æ³¨æ„ã—ã¾ã—ã‚‡ã†ã€‚"}
    ]},
    perfect: { name: "å®Œäº†å½¢", q: [
        {ja:"ç§ã¯3å¹´é–“ãšã£ã¨ãƒ†ãƒ‹ã‚¹ã‚’ã—ã¦ã„ã¾ã™ã€‚", en:["i", "have", "played", "tennis", "for", "three", "years", "."], exp:"ã€haveï¼‹éå»åˆ†è©ã€‘ã®ã€Œç¶™ç¶šã€ã‚’è¡¨ã—ã¾ã™ã€‚æœŸé–“ã‚’è¡¨ã™forã‚’ã‚»ãƒƒãƒˆã§ä½¿ã„ã¾ã™ã€‚"},
        {ja:"ã‚ãªãŸã¯ã‚‚ã†å®¿é¡Œã‚’çµ‚ãˆã¾ã—ãŸã‹ï¼Ÿ", en:["have", "you", "finished", "your", "homework", "yet", "?"], exp:"ã€Œã‚‚ã†ï½ã—ã¾ã—ãŸã‹ï¼Ÿã€ã¨ã„ã†ç–‘å•æ–‡ã§ã¯ã€æ–‡æœ«ã«yetã‚’ç½®ãã¾ã™ã€‚"}
    ]},
    post: { name: "å¾Œç½®ä¿®é£¾", q: [
        {ja:"å‘ã“ã†ã§æ­Œã£ã¦ã„ã‚‹å¥³ã®å­ã¯èŠ±å­ã§ã™ã€‚", en:["the", "girl", "singing", "over", "there", "is", "hanako", "."], exp:"ç¾åœ¨åˆ†è©(~ing)ãŒã€å‰ã®åè©(the girl)ã‚’å¾Œã‚ã‹ã‚‰è©³ã—ãèª¬æ˜ã—ã¦ã„ã¾ã™ã€‚"}
    ]},
    relative: { name: "é–¢ä¿‚ä»£åè©", q: [
        {ja:"ã“ã‚Œã¯ç§ãŒæ˜¨æ—¥è²·ã£ãŸã‚«ãƒ¡ãƒ©ã§ã™ã€‚", en:["this", "is", "the", "camera", "that", "i", "bought", "yesterday", "."], exp:"é–¢ä¿‚ä»£åè©thatãŒã€å…ˆè¡Œè©cameraã‚’ä¿®é£¾ã—ã¦ã„ã¾ã™ã€‚åè©ã®ã™ãå¾Œã‚ã«thatã‚’ç½®ãã¾ã™ã€‚"}
    ]},
    indirect: { name: "é–“æ¥ç–‘å•æ–‡", q: [
        {ja:"å½¼ãŒã©ã“ã«ä½ã‚“ã§ã„ã‚‹ã‹çŸ¥ã£ã¦ã„ã¾ã™ã‹ï¼Ÿ", en:["do", "you", "know", "where", "he", "lives", "?"], exp:"ç–‘å•è©ã®å¾Œã‚ã¯ã€Œä¸»èªï¼‹å‹•è©ã€ã®èªé †ã«ãªã‚Šã¾ã™ã€‚livesã®sã‚’å¿˜ã‚Œãšã«ï¼"}
    ]}
    // ... å¿…è¦ã«å¿œã˜ã¦å•é¡Œã‚’è¿½åŠ ã§ãã¾ã™
};

// ã‚¹ã‚³ã‚¢ç®¡ç†
let score = 0;
const ranks = [
    {min: 0, label: "BEGINNER"},
    {min: 500, label: "ROOKIE"},
    {min: 1000, label: "PRO"},
    {min: 2000, label: "MASTER"},
    {min: 3000, label: "LEGEND"}
];

function updateScore(pts) {
    score += pts;
    document.getElementById('score').innerText = score;
    const rankLabel = ranks.filter(r => score >= r.min).pop().label;
    document.getElementById('rank').innerText = rankLabel;
}

const grid = document.getElementById('grid');
Object.keys(data).forEach(key => {
    grid.innerHTML += `<label><input type="checkbox" value="${key}"> <span>${data[key].name}</span></label>`;
});

let currentQuestions = [], qIndex = 0;

function startGame() {
    const selected = Array.from(document.querySelectorAll('input:checked')).map(i => i.value);
    if(!selected.length) return alert("æ–‡æ³•ã‚’ãˆã‚‰ã‚“ã§ã­ï¼");
    currentQuestions = [];
    selected.forEach(k => {
        data[k].q.forEach(q => currentQuestions.push({...q, category: data[k].name}));
    });
    currentQuestions.sort(() => Math.random() - 0.5);
    qIndex = 0; score = 0; updateScore(0);
    document.getElementById('setup-screen').style.display = 'none';
    document.getElementById('game-screen').style.display = 'block';
    loadQuestion();
}

function loadQuestion() {
    const q = currentQuestions[qIndex];
    document.getElementById('ja-text').innerText = q.ja;
    document.getElementById('q-count').innerText = `Q. ${qIndex + 1} / ${currentQuestions.length}`;
    document.getElementById('feedback').innerText = "";
    document.getElementById('explanation-box').style.display = "none";
    document.getElementById('action-btn').style.display = "inline-block";
    
    const hand = document.getElementById('hand-zone');
    const drop = document.getElementById('drop-zone');
    hand.innerHTML = ""; drop.innerHTML = "";
    
    [...q.en].sort(() => Math.random() - 0.5).forEach(w => {
        const d = document.createElement('div');
        d.className = 'word-card' + (w === "." || w === "?" ? ' period' : '');
        d.innerText = w;
        hand.appendChild(d);
    });
}

const sortOptions = { group: 'words', animation: 200, ghostClass: 'ghost' };
new Sortable(document.getElementById('hand-zone'), sortOptions);
new Sortable(document.getElementById('drop-zone'), sortOptions);

function check() {
    const user = Array.from(document.getElementById('drop-zone').children).map(c => c.innerText).join(" ");
    const ans = currentQuestions[qIndex].en.join(" ");
    
    if(user === ans) {
        confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
        document.getElementById('feedback').innerHTML = "ğŸ‰ EXCELLENT!";
        updateScore(100);
        
        // è§£èª¬è¡¨ç¤º
        document.getElementById('action-btn').style.display = "none";
        document.getElementById('explanation-box').style.display = "block";
        document.getElementById('exp-grammar').innerText = `ã€ãƒ†ãƒ¼ãƒï¼š${currentQuestions[qIndex].category}ã€‘`;
        document.getElementById('exp-text').innerText = currentQuestions[qIndex].exp;
    } else {
        document.getElementById('feedback').innerHTML = "âŒ TRY AGAIN!";
        setTimeout(() => document.getElementById('feedback').innerText = "", 1000);
    }
}

function next() {
    qIndex++;
    if(qIndex < currentQuestions.length) {
        loadQuestion();
    } else {
        alert("ğŸ‰ ã‚¯ã‚¨ã‚¹ãƒˆã‚¯ãƒªã‚¢ï¼ æœ€çµ‚ã‚¹ã‚³ã‚¢: " + score);
        location.reload();
    }
}
</script>
</body>
</html>
